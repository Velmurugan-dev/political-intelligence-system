{% extends "base.html" %}

{% block title %}Source Monitoring - Political Intelligence{% endblock %}

{% block extra_head %}
<style>
    .monitoring-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 2rem;
        border-radius: 12px;
        margin-bottom: 2rem;
        text-align: center;
    }
    
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-bottom: 2rem;
    }
    
    .stat-card {
        background: white;
        padding: 1.5rem;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        text-align: center;
        border-left: 4px solid #667eea;
    }
    
    .stat-number {
        font-size: 2.5rem;
        font-weight: bold;
        color: #667eea;
        display: block;
    }
    
    .stat-label {
        color: #666;
        font-size: 0.9rem;
        margin-top: 0.5rem;
    }
    
    .monitoring-controls {
        background: white;
        padding: 1.5rem;
        border-radius: 8px;
        margin-bottom: 2rem;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .control-group {
        display: flex;
        gap: 1rem;
        align-items: center;
        margin-bottom: 1rem;
    }
    
    .control-group:last-child {
        margin-bottom: 0;
    }
    
    .sources-table {
        background: white;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .table-header {
        background: #f8f9fa;
        padding: 1rem 1.5rem;
        border-bottom: 1px solid #eee;
        font-weight: bold;
    }
    
    .source-row {
        padding: 1rem 1.5rem;
        border-bottom: 1px solid #f0f0f0;
        display: grid;
        grid-template-columns: 2fr 1fr 1fr 1fr 1fr 120px;
        align-items: center;
        gap: 1rem;
    }
    
    .source-row:hover {
        background: #f8f9fa;
    }
    
    .source-info {
        display: flex;
        flex-direction: column;
    }
    
    .source-name {
        font-weight: bold;
        color: #333;
        margin-bottom: 0.25rem;
    }
    
    .source-url {
        color: #666;
        font-size: 0.9rem;
        text-decoration: none;
    }
    
    .source-url:hover {
        color: #667eea;
    }
    
    .competitor-badge {
        display: inline-block;
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: bold;
        color: white;
    }
    
    .platform-badge {
        display: inline-block;
        padding: 0.25rem 0.75rem;
        border-radius: 4px;
        font-size: 0.8rem;
        background: #e9ecef;
        color: #495057;
    }
    
    .status-badge {
        display: inline-block;
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: bold;
    }
    
    .status-active {
        background: #28a745;
        color: white;
    }
    
    .status-inactive {
        background: #dc3545;
        color: white;
    }
    
    .last-checked {
        font-size: 0.9rem;
        color: #666;
    }
    
    .actions {
        display: flex;
        gap: 0.5rem;
    }
    
    .btn-sm {
        padding: 0.375rem 0.75rem;
        font-size: 0.875rem;
        border-radius: 4px;
        border: none;
        cursor: pointer;
        text-decoration: none;
    }
    
    .btn-primary {
        background: #667eea;
        color: white;
    }
    
    .btn-secondary {
        background: #6c757d;
        color: white;
    }
    
    .btn-success {
        background: #28a745;
        color: white;
    }
    
    .btn-danger {
        background: #dc3545;
        color: white;
    }
    
    .btn-sm:hover {
        opacity: 0.8;
    }
    
    .no-sources {
        text-align: center;
        padding: 3rem;
        color: #666;
    }
    
    /* Modal Styles */
    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        z-index: 1000;
    }
    
    .modal-content {
        background: white;
        margin: 5% auto;
        padding: 2rem;
        border-radius: 8px;
        width: 90%;
        max-width: 600px;
        position: relative;
    }
    
    .close {
        position: absolute;
        top: 1rem;
        right: 1rem;
        font-size: 1.5rem;
        cursor: pointer;
        color: #666;
    }
    
    .form-group {
        margin-bottom: 1rem;
    }
    
    .form-group label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: bold;
    }
    
    .form-control {
        width: 100%;
        padding: 0.75rem;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 1rem;
    }
    
    .form-control:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.25);
    }
    
    .cron-examples {
        margin-top: 0.5rem;
        font-size: 0.8rem;
        color: #666;
    }
    
    .cron-example {
        display: block;
        margin-bottom: 0.25rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="monitoring-header">
    <h1><i class="fas fa-satellite-dish"></i> Source Monitoring</h1>
    <p>Monitor social media channels and news sources for real-time content discovery</p>
</div>

<div class="stats-grid">
    <div class="stat-card">
        <span class="stat-number" id="total-sources">0</span>
        <div class="stat-label">Total Sources</div>
    </div>
    <div class="stat-card">
        <span class="stat-number" id="active-sources">0</span>
        <div class="stat-label">Active Sources</div>
    </div>
    <div class="stat-card">
        <span class="stat-number" id="scheduled-sources">0</span>
        <div class="stat-label">Scheduled Sources</div>
    </div>
    <div class="stat-card">
        <span class="stat-number" id="checked-today">0</span>
        <div class="stat-label">Checked Today</div>
    </div>
</div>

<div class="monitoring-controls">
    <div class="control-group">
        <label for="competitor-filter">Filter by Competitor:</label>
        <select id="competitor-filter" class="form-control" style="width: auto;">
            <option value="">All Competitors</option>
        </select>
        
        <label for="platform-filter">Platform:</label>
        <select id="platform-filter" class="form-control" style="width: auto;">
            <option value="">All Platforms</option>
        </select>
        
        <label for="status-filter">Status:</label>
        <select id="status-filter" class="form-control" style="width: auto;">
            <option value="">All Status</option>
            <option value="active">Active</option>
            <option value="inactive">Inactive</option>
        </select>
    </div>
    
    <div class="control-group">
        <button id="add-source-btn" class="btn btn-primary">
            <i class="fas fa-plus"></i> Add Source
        </button>
        <button id="bulk-check-btn" class="btn btn-success">
            <i class="fas fa-sync"></i> Check All Active
        </button>
        <button id="export-sources-btn" class="btn btn-secondary">
            <i class="fas fa-download"></i> Export Sources
        </button>
    </div>
</div>

<div class="sources-table">
    <div class="table-header">
        <div class="source-row">
            <div><strong>Source</strong></div>
            <div><strong>Competitor</strong></div>
            <div><strong>Platform</strong></div>
            <div><strong>Status</strong></div>
            <div><strong>Last Checked</strong></div>
            <div><strong>Actions</strong></div>
        </div>
    </div>
    
    <div id="sources-list">
        <div class="no-sources">
            <i class="fas fa-satellite-dish" style="font-size: 3rem; color: #ddd; margin-bottom: 1rem;"></i>
            <p>No sources found. Add sources to start monitoring.</p>
        </div>
    </div>
</div>

<!-- Add/Edit Source Modal -->
<div id="source-modal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <h3 id="modal-title">Add New Source</h3>
        
        <form id="source-form">
            <input type="hidden" id="source-id" name="id">
            
            <div class="form-group">
                <label for="source-competitor">Competitor *</label>
                <select id="source-competitor" name="competitor_id" class="form-control" required>
                    <option value="">Select Competitor</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="source-platform">Platform *</label>
                <select id="source-platform" name="platform_id" class="form-control" required>
                    <option value="">Select Platform</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="source-name">Source Name *</label>
                <input type="text" id="source-name" name="name" class="form-control" 
                       placeholder="e.g., ADMK Official Page" required>
            </div>
            
            <div class="form-group">
                <label for="source-url">URL *</label>
                <input type="url" id="source-url" name="url" class="form-control" 
                       placeholder="https://facebook.com/page" required>
            </div>
            
            <div class="form-group">
                <label for="source-type">Source Type</label>
                <select id="source-type" name="source_type" class="form-control">
                    <option value="social_media">Social Media</option>
                    <option value="news_website">News Website</option>
                    <option value="blog">Blog</option>
                    <option value="official_website">Official Website</option>
                    <option value="rss_feed">RSS Feed</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="monitoring-schedule">Monitoring Schedule</label>
                <select id="monitoring-schedule" name="schedule_type" class="form-control">
                    <option value="manual">Manual Only</option>
                    <option value="hourly">Every Hour</option>
                    <option value="every_6_hours">Every 6 Hours</option>
                    <option value="daily">Daily</option>
                    <option value="custom">Custom Cron</option>
                </select>
            </div>
            
            <div class="form-group" id="cron-group" style="display: none;">
                <label for="cron-expression">Cron Expression</label>
                <input type="text" id="cron-expression" name="cron_expression" class="form-control" 
                       placeholder="0 */6 * * *">
                <div class="cron-examples">
                    <span class="cron-example"><strong>0 */6 * * *</strong> - Every 6 hours</span>
                    <span class="cron-example"><strong>0 9 * * *</strong> - Daily at 9 AM</span>
                    <span class="cron-example"><strong>0 9 * * 1-5</strong> - Weekdays at 9 AM</span>
                </div>
            </div>
            
            <div class="form-group">
                <label for="priority-level">Priority Level</label>
                <select id="priority-level" name="priority_level" class="form-control">
                    <option value="1">High (1)</option>
                    <option value="2">Medium (2)</option>
                    <option value="3">Low (3)</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>
                    <input type="checkbox" id="source-active" name="is_active" checked> 
                    Active
                </label>
            </div>
            
            <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 2rem;">
                <button type="button" id="cancel-btn" class="btn btn-secondary">Cancel</button>
                <button type="submit" class="btn btn-primary">Save Source</button>
            </div>
        </form>
    </div>
</div>

<!-- Schedule Modal -->
<div id="schedule-modal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <h3>Schedule Monitoring</h3>
        
        <form id="schedule-form">
            <input type="hidden" id="schedule-source-id" name="source_id">
            
            <div class="form-group">
                <label for="schedule-frequency">Frequency</label>
                <select id="schedule-frequency" name="frequency" class="form-control">
                    <option value="hourly">Every Hour</option>
                    <option value="every_6_hours">Every 6 Hours</option>
                    <option value="daily">Daily</option>
                    <option value="weekly">Weekly</option>
                    <option value="custom">Custom</option>
                </select>
            </div>
            
            <div class="form-group" id="custom-cron-group" style="display: none;">
                <label for="custom-cron">Cron Expression</label>
                <input type="text" id="custom-cron" name="cron_expression" class="form-control">
            </div>
            
            <div class="form-group">
                <label for="schedule-priority">Priority</label>
                <select id="schedule-priority" name="priority_level" class="form-control">
                    <option value="1">High</option>
                    <option value="2">Medium</option>
                    <option value="3">Low</option>
                </select>
            </div>
            
            <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 2rem;">
                <button type="button" class="btn btn-secondary close-modal">Cancel</button>
                <button type="submit" class="btn btn-primary">Save Schedule</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let sources = [];
let competitors = [];
let platforms = [];

// WebSocket connection for real-time updates
let ws = null;

function connectWebSocket() {
    ws = new WebSocket(`ws://${window.location.host}/ws/monitoring`);
    
    ws.onmessage = function(event) {
        const data = JSON.parse(event.data);
        if (data.type === 'source_check_completed') {
            updateSourceLastChecked(data.source_id, data.last_checked);
        } else if (data.type === 'monitoring_stats_update') {
            updateStats(data.stats);
        }
    };
    
    ws.onclose = function() {
        // Reconnect after 5 seconds
        setTimeout(connectWebSocket, 5000);
    };
}

async function loadData() {
    try {
        // Load competitors, platforms, and sources
        const [competitorsRes, platformsRes, sourcesRes] = await Promise.all([
            fetch('/api/competitors'),
            fetch('/api/platforms'),
            fetch('/api/monitoring/sources')
        ]);
        
        competitors = await competitorsRes.json();
        platforms = await platformsRes.json();
        sources = await sourcesRes.json();
        
        populateFilters();
        populateModalSelects();
        renderSources();
        updateStats();
        
    } catch (error) {
        console.error('Failed to load data:', error);
    }
}

function populateFilters() {
    const competitorFilter = document.getElementById('competitor-filter');
    const platformFilter = document.getElementById('platform-filter');
    
    // Populate competitor filter
    competitorFilter.innerHTML = '<option value="">All Competitors</option>';
    competitors.forEach(comp => {
        competitorFilter.innerHTML += `<option value="${comp.id}">${comp.name}</option>`;
    });
    
    // Populate platform filter
    platformFilter.innerHTML = '<option value="">All Platforms</option>';
    platforms.forEach(plat => {
        platformFilter.innerHTML += `<option value="${plat.id}">${plat.name}</option>`;
    });
}

function populateModalSelects() {
    const sourceCompetitor = document.getElementById('source-competitor');
    const sourcePlatform = document.getElementById('source-platform');
    
    // Populate competitor select
    sourceCompetitor.innerHTML = '<option value="">Select Competitor</option>';
    competitors.forEach(comp => {
        sourceCompetitor.innerHTML += `<option value="${comp.id}">${comp.name}</option>`;
    });
    
    // Populate platform select
    sourcePlatform.innerHTML = '<option value="">Select Platform</option>';
    platforms.forEach(plat => {
        sourcePlatform.innerHTML += `<option value="${plat.id}">${plat.name}</option>`;
    });
}

function renderSources() {
    const sourcesList = document.getElementById('sources-list');
    
    // Apply filters
    let filteredSources = sources;
    
    const competitorFilter = document.getElementById('competitor-filter').value;
    const platformFilter = document.getElementById('platform-filter').value;
    const statusFilter = document.getElementById('status-filter').value;
    
    if (competitorFilter) {
        filteredSources = filteredSources.filter(s => s.competitor_id == competitorFilter);
    }
    
    if (platformFilter) {
        filteredSources = filteredSources.filter(s => s.platform_id == platformFilter);
    }
    
    if (statusFilter) {
        filteredSources = filteredSources.filter(s => 
            statusFilter === 'active' ? s.is_active : !s.is_active
        );
    }
    
    if (filteredSources.length === 0) {
        sourcesList.innerHTML = `
            <div class="no-sources">
                <i class="fas fa-satellite-dish" style="font-size: 3rem; color: #ddd; margin-bottom: 1rem;"></i>
                <p>No sources found with current filters.</p>
            </div>
        `;
        return;
    }
    
    sourcesList.innerHTML = filteredSources.map(source => {
        const competitor = competitors.find(c => c.id === source.competitor_id);
        const platform = platforms.find(p => p.id === source.platform_id);
        
        return `
            <div class="source-row" data-source-id="${source.id}">
                <div class="source-info">
                    <div class="source-name">${source.name}</div>
                    <a href="${source.url}" target="_blank" class="source-url">
                        ${source.url.substring(0, 60)}${source.url.length > 60 ? '...' : ''}
                    </a>
                </div>
                <div>
                    <span class="competitor-badge" style="background: ${getCompetitorColor(competitor?.name)}">
                        ${competitor?.name || 'Unknown'}
                    </span>
                </div>
                <div>
                    <span class="platform-badge">${platform?.name || 'Unknown'}</span>
                </div>
                <div>
                    <span class="status-badge ${source.is_active ? 'status-active' : 'status-inactive'}">
                        ${source.is_active ? 'Active' : 'Inactive'}
                    </span>
                </div>
                <div class="last-checked">
                    ${source.last_checked ? formatDateTime(source.last_checked) : 'Never'}
                </div>
                <div class="actions">
                    <button class="btn btn-sm btn-primary" onclick="checkSource(${source.id})">
                        <i class="fas fa-sync"></i>
                    </button>
                    <button class="btn btn-sm btn-secondary" onclick="editSource(${source.id})">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-sm btn-success" onclick="scheduleSource(${source.id})">
                        <i class="fas fa-clock"></i>
                    </button>
                    <button class="btn btn-sm btn-danger" onclick="deleteSource(${source.id})">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        `;
    }).join('');
}

function updateStats() {
    document.getElementById('total-sources').textContent = sources.length;
    document.getElementById('active-sources').textContent = sources.filter(s => s.is_active).length;
    
    // Calculate scheduled sources and checked today
    const scheduledSources = sources.filter(s => s.schedule_id).length;
    const today = new Date().toDateString();
    const checkedToday = sources.filter(s => 
        s.last_checked && new Date(s.last_checked).toDateString() === today
    ).length;
    
    document.getElementById('scheduled-sources').textContent = scheduledSources;
    document.getElementById('checked-today').textContent = checkedToday;
}

function getCompetitorColor(name) {
    const colors = {
        'ADMK': '#e74c3c',
        'DMK': '#f39c12',
        'BJP': '#e67e22',
        'NTK': '#3498db',
        'PMK': '#2ecc71',
        'TVK': '#9b59b6',
        'DMDK': '#34495e'
    };
    return colors[name] || '#95a5a6';
}

function formatDateTime(dateStr) {
    const date = new Date(dateStr);
    return date.toLocaleString();
}

// Source Management Functions
async function addSource() {
    document.getElementById('modal-title').textContent = 'Add New Source';
    document.getElementById('source-form').reset();
    document.getElementById('source-id').value = '';
    document.getElementById('source-modal').style.display = 'block';
}

function editSource(sourceId) {
    const source = sources.find(s => s.id === sourceId);
    if (!source) return;
    
    document.getElementById('modal-title').textContent = 'Edit Source';
    document.getElementById('source-id').value = source.id;
    document.getElementById('source-competitor').value = source.competitor_id;
    document.getElementById('source-platform').value = source.platform_id;
    document.getElementById('source-name').value = source.name;
    document.getElementById('source-url').value = source.url;
    document.getElementById('source-type').value = source.source_type;
    document.getElementById('priority-level').value = source.priority_level;
    document.getElementById('source-active').checked = source.is_active;
    
    document.getElementById('source-modal').style.display = 'block';
}

async function checkSource(sourceId) {
    try {
        const response = await fetch(`/api/monitoring/sources/${sourceId}/check`, {
            method: 'POST'
        });
        
        if (response.ok) {
            alert('Source check initiated. Results will appear shortly.');
        } else {
            alert('Failed to initiate source check');
        }
    } catch (error) {
        console.error('Error checking source:', error);
        alert('Error checking source');
    }
}

function scheduleSource(sourceId) {
    document.getElementById('schedule-source-id').value = sourceId;
    document.getElementById('schedule-modal').style.display = 'block';
}

async function deleteSource(sourceId) {
    if (!confirm('Are you sure you want to delete this source?')) return;
    
    try {
        const response = await fetch(`/api/monitoring/sources/${sourceId}`, {
            method: 'DELETE'
        });
        
        if (response.ok) {
            sources = sources.filter(s => s.id !== sourceId);
            renderSources();
            updateStats();
        } else {
            alert('Failed to delete source');
        }
    } catch (error) {
        console.error('Error deleting source:', error);
        alert('Error deleting source');
    }
}

async function bulkCheckSources() {
    if (!confirm('This will check all active sources. Continue?')) return;
    
    try {
        const response = await fetch('/api/monitoring/bulk-check', {
            method: 'POST'
        });
        
        if (response.ok) {
            alert('Bulk check initiated for all active sources');
        } else {
            alert('Failed to initiate bulk check');
        }
    } catch (error) {
        console.error('Error in bulk check:', error);
        alert('Error in bulk check');
    }
}

// Event Listeners
document.addEventListener('DOMContentLoaded', function() {
    loadData();
    connectWebSocket();
    
    // Filter change listeners
    document.getElementById('competitor-filter').addEventListener('change', renderSources);
    document.getElementById('platform-filter').addEventListener('change', renderSources);
    document.getElementById('status-filter').addEventListener('change', renderSources);
    
    // Button listeners
    document.getElementById('add-source-btn').addEventListener('click', addSource);
    document.getElementById('bulk-check-btn').addEventListener('click', bulkCheckSources);
    
    // Modal listeners
    document.querySelectorAll('.close').forEach(close => {
        close.addEventListener('click', function() {
            this.closest('.modal').style.display = 'none';
        });
    });
    
    document.querySelectorAll('.close-modal').forEach(btn => {
        btn.addEventListener('click', function() {
            this.closest('.modal').style.display = 'none';
        });
    });
    
    // Form submit listeners
    document.getElementById('source-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        const data = Object.fromEntries(formData);
        
        // Convert checkbox to boolean
        data.is_active = document.getElementById('source-active').checked;
        
        try {
            const url = data.id ? `/api/monitoring/sources/${data.id}` : '/api/monitoring/sources';
            const method = data.id ? 'PUT' : 'POST';
            
            const response = await fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            });
            
            if (response.ok) {
                document.getElementById('source-modal').style.display = 'none';
                loadData(); // Reload data
            } else {
                alert('Failed to save source');
            }
        } catch (error) {
            console.error('Error saving source:', error);
            alert('Error saving source');
        }
    });
    
    // Schedule type change listener
    document.getElementById('monitoring-schedule').addEventListener('change', function() {
        const cronGroup = document.getElementById('cron-group');
        cronGroup.style.display = this.value === 'custom' ? 'block' : 'none';
    });
    
    document.getElementById('schedule-frequency').addEventListener('change', function() {
        const customCronGroup = document.getElementById('custom-cron-group');
        customCronGroup.style.display = this.value === 'custom' ? 'block' : 'none';
    });
    
    // Close modals when clicking outside
    window.addEventListener('click', function(e) {
        if (e.target.classList.contains('modal')) {
            e.target.style.display = 'none';
        }
    });
});

// Helper function to update source last checked time
function updateSourceLastChecked(sourceId, lastChecked) {
    const sourceIndex = sources.findIndex(s => s.id === sourceId);
    if (sourceIndex !== -1) {
        sources[sourceIndex].last_checked = lastChecked;
        renderSources();
        updateStats();
    }
}
</script>
{% endblock %}