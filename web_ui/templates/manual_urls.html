{% extends "base.html" %}

{% block title %}Manual URL Submission - Political Intelligence{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>ðŸ“Ž Manual URL Submission</h2>
    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#submitUrlModal">
        <i class="fas fa-plus"></i> Submit URL
    </button>
</div>

<div class="row mb-4">
    <!-- Quick Submit Form -->
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5>âš¡ Quick Submit</h5>
            </div>
            <div class="card-body">
                <form id="quickSubmitForm">
                    <div class="mb-3">
                        <label for="quickUrl" class="form-label">URL *</label>
                        <input type="url" class="form-control" id="quickUrl" placeholder="https://..." required>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="quickCompetitor" class="form-label">Competitor *</label>
                            <select class="form-select" id="quickCompetitor" required>
                                <option value="">Select competitor...</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="quickPlatform" class="form-label">Platform *</label>
                            <select class="form-select" id="quickPlatform" required>
                                <option value="">Select platform...</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="quickNotes" class="form-label">Notes</label>
                        <textarea class="form-control" id="quickNotes" rows="2" placeholder="Optional notes about this URL"></textarea>
                    </div>
                    
                    <button type="submit" class="btn btn-success w-100">
                        <i class="fas fa-paper-plane"></i> Submit URL
                    </button>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Bulk Submit -->
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5>ðŸ“„ Bulk Submit</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label for="bulkUrls" class="form-label">URLs (one per line)</label>
                    <textarea class="form-control" id="bulkUrls" rows="6" placeholder="https://example.com/post1&#10;https://example.com/post2&#10;..."></textarea>
                </div>
                
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="bulkCompetitor" class="form-label">Competitor *</label>
                        <select class="form-select" id="bulkCompetitor" required>
                            <option value="">Select competitor...</option>
                        </select>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="bulkPlatform" class="form-label">Platform *</label>
                        <select class="form-select" id="bulkPlatform" required>
                            <option value="">Select platform...</option>
                        </select>
                    </div>
                </div>
                
                <button type="button" class="btn btn-warning w-100" onclick="submitBulkUrls()">
                    <i class="fas fa-upload"></i> Submit Bulk URLs
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Submission Queue -->
<div class="card">
    <div class="card-header d-flex justify-content-between">
        <h5>ðŸ“‹ Submission Queue</h5>
        <div>
            <select class="form-select form-select-sm d-inline-block w-auto" id="statusFilter" onchange="filterQueue()">
                <option value="">All Status</option>
                <option value="pending">Pending</option>
                <option value="processing">Processing</option>
                <option value="processed">Processed</option>
                <option value="failed">Failed</option>
                <option value="duplicate">Duplicate</option>
            </select>
            <button class="btn btn-sm btn-outline-primary ms-2" onclick="refreshQueue()">
                <i class="fas fa-refresh"></i>
            </button>
        </div>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-sm">
                <thead>
                    <tr>
                        <th>URL</th>
                        <th>Competitor</th>
                        <th>Platform</th>
                        <th>Priority</th>
                        <th>Status</th>
                        <th>Submitted</th>
                        <th>Notes</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="queueTableBody">
                    <tr>
                        <td colspan="8" class="text-center text-muted">Loading queue...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Submit URL Modal (Advanced) -->
<div class="modal fade" id="submitUrlModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">ðŸ“Ž Submit URL for Processing</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="submitUrlForm">
                    <div class="mb-3">
                        <label for="modalUrl" class="form-label">URL *</label>
                        <input type="url" class="form-control" id="modalUrl" placeholder="https://..." required>
                        <div class="form-text">Enter the complete URL to be scraped for engagement metrics</div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="modalCompetitor" class="form-label">Competitor *</label>
                            <select class="form-select" id="modalCompetitor" required>
                                <option value="">Select competitor...</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="modalPlatform" class="form-label">Platform *</label>
                            <select class="form-select" id="modalPlatform" required>
                                <option value="">Select platform...</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="modalPriority" class="form-label">Priority</label>
                            <select class="form-select" id="modalPriority">
                                <option value="3">Low Priority</option>
                                <option value="2">Medium Priority</option>
                                <option value="1">High Priority</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="modalSubmittedBy" class="form-label">Submitted By</label>
                            <input type="text" class="form-control" id="modalSubmittedBy" placeholder="Your name" value="Web UI">
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="modalNotes" class="form-label">Notes</label>
                        <textarea class="form-control" id="modalNotes" rows="3" placeholder="Optional notes about this URL, why it's important, etc."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="submitUrl()">
                    <i class="fas fa-paper-plane"></i> Submit URL
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_scripts %}
<script>
let allCompetitors = [];
let allPlatforms = [];
let currentQueueData = [];

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    loadInitialData();
    
    // Setup form handlers
    document.getElementById('quickSubmitForm').addEventListener('submit', function(e) {
        e.preventDefault();
        submitQuickUrl();
    });
});

async function loadInitialData() {
    try {
        // Load competitors and platforms for dropdowns
        const [competitors, platforms] = await Promise.all([
            apiRequest('/api/competitors'),
            apiRequest('/api/platforms')
        ]);
        
        allCompetitors = competitors;
        allPlatforms = platforms;
        
        populateDropdowns();
        refreshQueue();
        
    } catch (error) {
        console.error('Error loading initial data:', error);
        showNotification('Failed to load initial data', 'error');
    }
}

function populateDropdowns() {
    const competitorSelects = ['quickCompetitor', 'bulkCompetitor', 'modalCompetitor'];
    const platformSelects = ['quickPlatform', 'bulkPlatform', 'modalPlatform'];
    
    // Populate competitor dropdowns
    competitorSelects.forEach(selectId => {
        const select = document.getElementById(selectId);
        select.innerHTML = '<option value="">Select competitor...</option>' +
            allCompetitors.map(comp => 
                `<option value="${comp.competitor_id}">${comp.display_name} (${comp.short_code})</option>`
            ).join('');
    });
    
    // Populate platform dropdowns
    platformSelects.forEach(selectId => {
        const select = document.getElementById(selectId);
        select.innerHTML = '<option value="">Select platform...</option>' +
            allPlatforms.map(plat => 
                `<option value="${plat.platform_id}">${plat.display_name}</option>`
            ).join('');
    });
}

async function submitQuickUrl() {
    const urlData = {
        competitor_id: parseInt(document.getElementById('quickCompetitor').value),
        platform_id: parseInt(document.getElementById('quickPlatform').value),
        url: document.getElementById('quickUrl').value,
        priority: 2, // Medium priority for quick submit
        notes: document.getElementById('quickNotes').value || null
    };
    
    try {
        await apiRequest('/api/manual-queue', {
            method: 'POST',
            body: JSON.stringify(urlData)
        });
        
        showNotification('URL submitted successfully', 'success');
        document.getElementById('quickSubmitForm').reset();
        refreshQueue();
        
    } catch (error) {
        console.error('Error submitting URL:', error);
        showNotification('Failed to submit URL: ' + error.message, 'error');
    }
}

async function submitUrl() {
    const urlData = {
        competitor_id: parseInt(document.getElementById('modalCompetitor').value),
        platform_id: parseInt(document.getElementById('modalPlatform').value),
        url: document.getElementById('modalUrl').value,
        priority: parseInt(document.getElementById('modalPriority').value),
        notes: document.getElementById('modalNotes').value || null
    };
    
    try {
        await apiRequest('/api/manual-queue', {
            method: 'POST',
            body: JSON.stringify(urlData)
        });
        
        const modal = bootstrap.Modal.getInstance(document.getElementById('submitUrlModal'));
        modal.hide();
        document.getElementById('submitUrlForm').reset();
        
        showNotification('URL submitted successfully', 'success');
        refreshQueue();
        
    } catch (error) {
        console.error('Error submitting URL:', error);
        showNotification('Failed to submit URL: ' + error.message, 'error');
    }
}

async function submitBulkUrls() {
    const urls = document.getElementById('bulkUrls').value.trim().split('\n').filter(url => url.trim());
    const competitorId = parseInt(document.getElementById('bulkCompetitor').value);
    const platformId = parseInt(document.getElementById('bulkPlatform').value);
    
    if (!competitorId || !platformId || urls.length === 0) {
        showNotification('Please fill all required fields and add at least one URL', 'error');
        return;
    }
    
    try {
        let successCount = 0;
        let errorCount = 0;
        
        for (const url of urls) {
            try {
                await apiRequest('/api/manual-queue', {
                    method: 'POST',
                    body: JSON.stringify({
                        competitor_id: competitorId,
                        platform_id: platformId,
                        url: url.trim(),
                        priority: 2,
                        notes: 'Bulk submission'
                    })
                });
                successCount++;
            } catch {
                errorCount++;
            }
        }
        
        showNotification(`Bulk submission completed: ${successCount} successful, ${errorCount} failed`, 
                        errorCount === 0 ? 'success' : 'warning');
        
        // Clear form
        document.getElementById('bulkUrls').value = '';
        document.getElementById('bulkCompetitor').value = '';
        document.getElementById('bulkPlatform').value = '';
        
        refreshQueue();
        
    } catch (error) {
        console.error('Error in bulk submission:', error);
        showNotification('Bulk submission failed: ' + error.message, 'error');
    }
}

async function refreshQueue() {
    try {
        const queueData = await apiRequest('/api/manual-queue');
        currentQueueData = queueData;
        renderQueueTable(queueData);
    } catch (error) {
        console.error('Error loading queue:', error);
        showNotification('Failed to load queue', 'error');
    }
}

function renderQueueTable(queueData) {
    const tbody = document.getElementById('queueTableBody');
    
    if (queueData.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">No URLs in queue</td></tr>';
        return;
    }
    
    tbody.innerHTML = queueData.map(item => `
        <tr>
            <td>
                <a href="${item.url}" target="_blank" class="text-truncate d-inline-block" style="max-width: 300px;" title="${item.url}">
                    ${item.url}
                </a>
            </td>
            <td>
                <span class="badge rounded-pill" style="background-color: ${getCompetitorColor(item.competitor_id)}">
                    ${item.competitor_name}
                </span>
            </td>
            <td><span class="badge bg-secondary">${item.platform_name}</span></td>
            <td>
                <span class="badge ${item.priority === 1 ? 'bg-danger' : item.priority === 2 ? 'bg-warning' : 'bg-secondary'}">
                    ${item.priority === 1 ? 'High' : item.priority === 2 ? 'Medium' : 'Low'}
                </span>
            </td>
            <td>
                <span class="badge ${getStatusBadgeClass(item.status)}">
                    ${item.status.toUpperCase()}
                </span>
            </td>
            <td>
                <small class="text-muted">${formatDateTime(item.created_at)}</small>
            </td>
            <td>
                <span class="text-truncate d-inline-block" style="max-width: 150px;" title="${item.notes || 'No notes'}">
                    ${item.notes || '-'}
                </span>
            </td>
            <td>
                <div class="btn-group" role="group">
                    ${item.status === 'pending' ? `
                        <button class="btn btn-sm btn-outline-success" onclick="retryUrl(${item.queue_id})" title="Retry">
                            <i class="fas fa-redo"></i>
                        </button>
                    ` : ''}
                    <button class="btn btn-sm btn-outline-danger" onclick="deleteQueueItem(${item.queue_id})" title="Delete">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </td>
        </tr>
    `).join('');
}

function getStatusBadgeClass(status) {
    switch (status) {
        case 'pending': return 'bg-warning';
        case 'processing': return 'bg-info';
        case 'processed': return 'bg-success';
        case 'failed': return 'bg-danger';
        case 'duplicate': return 'bg-secondary';
        default: return 'bg-light';
    }
}

function getCompetitorColor(competitorId) {
    const competitor = allCompetitors.find(c => c.competitor_id === competitorId);
    return competitor ? competitor.party_color : '#6c757d';
}

function filterQueue() {
    const status = document.getElementById('statusFilter').value;
    
    if (status === '') {
        renderQueueTable(currentQueueData);
    } else {
        const filtered = currentQueueData.filter(item => item.status === status);
        renderQueueTable(filtered);
    }
}

async function retryUrl(queueId) {
    try {
        await apiRequest(`/api/manual-queue/${queueId}/retry`, {
            method: 'POST'
        });
        
        showNotification('URL retry initiated', 'success');
        refreshQueue();
        
    } catch (error) {
        console.error('Error retrying URL:', error);
        showNotification('Failed to retry URL: ' + error.message, 'error');
    }
}

async function deleteQueueItem(queueId) {
    if (!confirm('Are you sure you want to delete this queue item?')) {
        return;
    }
    
    try {
        await apiRequest(`/api/manual-queue/${queueId}`, {
            method: 'DELETE'
        });
        
        showNotification('Queue item deleted', 'success');
        refreshQueue();
        
    } catch (error) {
        console.error('Error deleting queue item:', error);
        showNotification('Failed to delete queue item: ' + error.message, 'error');
    }
}

// Auto-refresh function for this page
function refreshPageData() {
    refreshQueue();
}
</script>
{% endblock %}